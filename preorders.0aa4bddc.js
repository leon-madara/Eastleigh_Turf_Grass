var S=(w,d,b)=>new Promise((m,g)=>{var I=s=>{try{y(b.next(s))}catch(h){g(h)}},v=s=>{try{y(b.throw(s))}catch(h){g(h)}},y=s=>s.done?m(s.value):Promise.resolve(s.value).then(I,v);y((b=b.apply(w,d)).next())});(()=>{let w=[],d=[],b=1;function m(e,t="success"){var o;typeof window.showToast=="function"?window.showToast(e,t):(o=window.BrokerDashboard)!=null&&o.showToast?window.BrokerDashboard.showToast(e,t):console.log("[".concat(t.toUpperCase(),"] ").concat(e))}function g(){return S(this,null,function*(){yield I(),$()})}function I(){return S(this,null,function*(){try{const e=yield fetch("/data/products.json");if(!e.ok)throw new Error("HTTP ".concat(e.status));w=yield e.json()}catch(e){console.error("Failed to load products:",e),m("Failed to load products","error"),w=[]}})}function v(){var t;const e={id:b++,productId:"",product:null,quantity:1,unitPrice:0,total:0,expectedDate:"",specialNotes:""};d.push(e),$(),m("Preorder item added","success"),(t=window.BrokerDashboard)!=null&&t.updateCartCount&&window.BrokerDashboard.updateCartCount(N())}function y(e){var t;d=d.filter(o=>o.id!==e),$(),m("Preorder item removed","success"),(t=window.BrokerDashboard)!=null&&t.updateCartCount&&window.BrokerDashboard.updateCartCount(N())}function s(e,t,o){var u,r,l,i;const n=d.find(a=>a.id===e);if(n){if(t==="productId"){const a=w.find(p=>String(p.id)===String(o));n.productId=o,n.product=a||null,n.unitPrice=a&&Number(a.price)||0,n.total=n.unitPrice*(Number(n.quantity)||0)}else if(t==="quantity"){const a=(i=(l=(r=(u=window.numberFormatter)==null?void 0:u.parseFormattedNumber)==null?void 0:r.call(u,o))!=null?l:parseFloat(String(o)))!=null?i:0;n.quantity=isNaN(a)?0:a,n.total=n.unitPrice*n.quantity}else t==="expectedDate"?n.expectedDate=o:t==="specialNotes"&&(n.specialNotes=o);$()}}function h(){return d.reduce((e,t)=>e+(Number(t.total)||0),0)}function F(e){const{brokerName:t,brokerEmail:o,items:n,expectedDate:u,specialNotes:r,total:l}=e,i=n.map(a=>{var E,c,P,k;const p=(c=(E=a.product)==null?void 0:E.name)!=null?c:"Unknown",f=(k=(P=a.product)==null?void 0:P.thickness)!=null?k:"";return"• ".concat(p," (").concat(f,")\n  Quantity: ").concat(a.quantity," m²\n  Unit Price: KES ").concat(Number(a.unitPrice).toLocaleString(),"\n  Total: KES ").concat(Number(a.total).toLocaleString())}).join("\n\n");return"*BROKER PREORDER SUBMISSION - Eastleigh Turf Grass*\n\n*Broker Details:*\n• Name: ".concat(t,"\n• Email: ").concat(o,"\n\n*Preorder Items:*\n").concat(i,"\n\n*Preorder Details:*\n• Expected Date: ").concat(u||"Not specified","\n• Special Notes: ").concat(r||"None","\n• Total Amount: KES ").concat(Number(l).toLocaleString(),"\n\n*Submitted:* ").concat(new Date().toLocaleString("en-KE"))}function $(){const e=document.getElementById("preorderTableBody"),t=document.getElementById("emptyPreorderState"),o=document.getElementById("preorderTotal"),n=document.getElementById("submitPreordersBtn");if(!e||!t||!o||!n)return;d.length===0?(e.innerHTML="",t.style.display="block",n.disabled=!0):(t.style.display="none",n.disabled=!1,e.innerHTML=d.map(r=>L(r)).join(""),d.forEach(r=>{var E;const l=document.getElementById("preorder-product-".concat(r.id)),i=document.getElementById("preorder-quantity-".concat(r.id)),a=document.getElementById("preorder-date-".concat(r.id)),p=document.getElementById("preorder-notes-".concat(r.id)),f=document.getElementById("delete-preorder-".concat(r.id));if(l==null||l.addEventListener("change",c=>s(r.id,"productId",c.target.value)),i)if(i.addEventListener("input",c=>s(r.id,"quantity",c.target.value)),(E=window.numberFormatter)!=null&&E.initInputFormatting)window.numberFormatter.initInputFormatting(i,{allowDecimals:!0,decimalPlaces:1,currency:"KES"});else{const c=setInterval(()=>{var P;(P=window.numberFormatter)!=null&&P.initInputFormatting&&(window.numberFormatter.initInputFormatting(i,{allowDecimals:!0,decimalPlaces:1,currency:"KES"}),clearInterval(c))},100)}a==null||a.addEventListener("change",c=>s(r.id,"expectedDate",c.target.value)),p==null||p.addEventListener("input",c=>s(r.id,"specialNotes",c.target.value)),f==null||f.addEventListener("click",()=>y(r.id))}));const u=h();o.textContent=Number(u).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}function L(e){const t=w.map(o=>'\n          <option value="'.concat(o.id,'" ').concat(String(e.productId)===String(o.id)?"selected":"",">\n            ").concat(o.name," (").concat(o.thickness,")\n          </option>")).join("");return'\n      <tr>\n        <td>\n          <div class="order-field">\n            <label for="preorder-product-'.concat(e.id,'">Product Name</label>\n            <select class="table-select" id="preorder-product-').concat(e.id,'">\n              <option value="">Select a product</option>\n              ').concat(t,'\n            </select>\n          </div>\n        </td>\n        <td>\n          <div class="order-field">\n            <label for="preorder-quantity-').concat(e.id,'">Quantity (m²)</label>\n            <input type="number" inputmode="decimal" class="table-input" id="preorder-quantity-').concat(e.id,'"\n                   value="').concat(e.quantity,'" min="0.1" step="0.1" placeholder="0">\n          </div>\n        </td>\n        <td>\n          <div class="order-field">\n            <label>Unit Price (KES)</label>\n            <input type="text" class="table-input" readonly value="').concat(Number(e.unitPrice).toLocaleString("en-US"),'">\n          </div>\n        </td>\n        <td>\n          <div class="order-field">\n            <label for="preorder-date-').concat(e.id,'">Expected Date</label>\n            <input type="date" class="table-input" id="preorder-date-').concat(e.id,'"\n                   value="').concat(e.expectedDate||"",'" placeholder="Expected date">\n          </div>\n        </td>\n        <td>\n          <div class="order-field">\n            <label for="preorder-notes-').concat(e.id,'">Special Notes</label>\n            <input type="text" class="table-input" id="preorder-notes-').concat(e.id,'"\n                   value="').concat(e.specialNotes||"",'" placeholder="Special notes">\n          </div>\n        </td>\n        <td>\n          <div class="order-field">\n            <label>Total (KES)</label>\n            <strong>').concat(Number(e.total).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),'</strong>\n          </div>\n        </td>\n        <td>\n          <div class="order-field">\n            <label>Action</label>\n            <button class="delete-btn" id="delete-preorder-').concat(e.id,'">\n              <i class="fas fa-trash"></i> Delete\n            </button>\n          </div>\n        </td>\n      </tr>')}function D(){return S(this,null,function*(){var t,o,n,u;if(d.length===0){m("No preorder items to submit","error");return}if(d.filter(r=>!r.productId||Number(r.quantity)<=0).length>0){m("Please complete all preorder items before submitting","error");return}try{const r={brokerName:"Broker User",brokerEmail:"broker@eastleighturf.com",items:d.map(i=>({product:i.product,quantity:i.quantity,unitPrice:i.unitPrice,total:i.total})),expectedDate:((t=d[0])==null?void 0:t.expectedDate)||"Not specified",specialNotes:((o=d[0])==null?void 0:o.specialNotes)||"None",total:h()};let l=!1;if((n=window.WhatsAppService)!=null&&n.sendPreorderForm){const i=window.WhatsAppService.sendPreorderForm(r);l=typeof(i==null?void 0:i.then)=="function"?yield i:!!i}else{const i=F(r),a="254743375997",p=encodeURIComponent(i),f="https://wa.me/".concat(a,"?text=").concat(p);window.open(f,"_blank"),l=!0}l?(m("Preorders submitted successfully! WhatsApp will open with your preorder details.","success"),d=[],b=1,$(),(u=window.BrokerDashboard)!=null&&u.updateCartCount&&window.BrokerDashboard.updateCartCount(N())):m("Failed to send preorders. Please try again.","error")}catch(r){console.error("Preorder submission error:",r),m("An error occurred while submitting the preorders.","error")}})}function N(){return d.length}function B(){var e,t;(e=document.getElementById("addPreorderBtn"))==null||e.addEventListener("click",v),(t=document.getElementById("submitPreordersBtn"))==null||t.addEventListener("click",D)}window.PreordersModule={init:g,addPreorder:v,removePreorder:y,updatePreorder:s,submitPreorders:D,getItemCount:N},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{g(),B()}):(g(),B())})();
