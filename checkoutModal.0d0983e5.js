var u=(e,t,o)=>new Promise((n,a)=>{var s=l=>{try{i(o.next(l))}catch(d){a(d)}},c=l=>{try{i(o.throw(l))}catch(d){a(d)}},i=l=>l.done?n(l.value):Promise.resolve(l.value).then(s,c);i((o=o.apply(e,t)).next())});const g={modal:null,isInitialized:!1,init(){console.log("Checkout modal initialized"),this.isInitialized=!0},open(){return u(this,null,function*(){yield this.createModal(),this.showModal(),this.currentStep=1,this.totalSteps=3})},close(){this.hideModal()},createModal(){return u(this,null,function*(){const e=document.getElementById("checkoutModal");e&&e.remove();try{const t=yield fetch("/src/public/partials/checkout-modal.html");if(!t.ok)throw new Error("Failed to load HTML partial: ".concat(t.status));const o=yield t.text();document.body.insertAdjacentHTML("beforeend",o),this.initializeModal(),this.bindEvents(),this.updateStepIndicator(),this.updateOrderSummary()}catch(t){console.error("Error loading checkout modal:",t),this.createFallbackModal()}})},createFallbackModal(){const e='\n            <div id="checkoutModal" class="checkout-modal active">\n                <div class="modal-overlay"></div>\n                <div class="modal-content">\n                    <div class="modal-header">                        \n                        <button class="modal-close" id="closeCheckoutModal" aria-label="Close modal">\n                            <i class="fas fa-times"></i>\n                        <h2>Checkout</h2>\n                        </button>\n                    </div>\n                    <div class="modal-body">\n                        <p>Error loading checkout form. Please try again.</p>\n                    </div>\n                    <div class="modal-footer">\n                        <button type="button" class="btn-secondary" id="closeCheckoutModal">Close</button>\n                    </div>\n                </div>\n            </div>\n        ';document.body.insertAdjacentHTML("beforeend",e),this.bindEvents()},initializeModal(){this.currentStep=1,this.totalSteps=3,console.log("Modal initialized, currentStep:",this.currentStep),this.showStep(1),this.updateButtonStates(),this.populateOrderSummary();const e=document.getElementById("backBtn");console.log("Back button in initializeModal:",e),e&&(console.log("Back button styles:",e.style.cssText),console.log("Back button computed styles:",window.getComputedStyle(e)))},showModal(){const e=document.getElementById("checkoutModal");if(e){e.classList.add("active"),e.removeAttribute("hidden"),setTimeout(()=>{this.initFloatingLabels()},100);const t=document.getElementById("customerName");t&&t.focus()}},hideModal(){const e=document.getElementById("checkoutModal");e&&e.remove()},bindEvents(){const e=document.getElementById("closeCheckoutModal");e&&e.addEventListener("click",()=>this.close());const t=document.getElementById("backBtn");t&&t.addEventListener("click",()=>this.previousStep());const o=document.getElementById("nextBtn");o&&o.addEventListener("click",()=>this.nextStep());const n=document.getElementById("sendBtn");n&&n.addEventListener("click",()=>this.sendOrder()),document.querySelectorAll(".md3-stepper .step").forEach((r,h)=>{r.addEventListener("click",()=>{const m=h+1;m<=this.currentStep&&this.showStep(m)})});const s=document.getElementById("checkoutModal"),c=document.querySelector(".md3-modal__backdrop");s&&s.addEventListener("click",r=>{(r.target===s||r.target===c)&&this.close()}),c&&c.addEventListener("click",()=>this.close());const i=document.getElementById("customerDetailsForm");i&&i.addEventListener("submit",r=>{r.preventDefault(),this.nextStep()});const l=document.getElementById("detectPhoneBtn");l&&l.addEventListener("click",()=>this.detectPhoneFromContacts());const d=document.getElementById("detectLocationBtn");d&&d.addEventListener("click",()=>this.detectLocationFromGPS()),this.loadSavedDetails(),this.initFloatingLabels()},populateOrderSummary(){const e=window.CartComponent?window.CartComponent.getItems():[],t=window.CartComponent?window.CartComponent.getTotal():0,n=t+500,a=document.getElementById("summaryName"),s=document.getElementById("summaryPhone"),c=document.getElementById("summaryLocation"),i=document.getElementById("totalArea"),l=document.getElementById("summarySubtotal"),d=document.getElementById("summaryDiscount"),r=document.getElementById("summaryTotal");a&&(a.textContent=""),s&&(s.textContent=""),c&&(c.textContent=""),i&&(i.textContent="0 mÂ²"),l&&(l.textContent="KES ".concat(t.toLocaleString())),d&&(d.textContent="-KES 0"),r&&(r.textContent="KES ".concat(n.toLocaleString()));const h=document.getElementById("orderItemsList");h&&e.length>0&&(h.innerHTML=e.map(m=>'\n                <div class="order-item">\n                    <span class="item-name">'.concat(m.name,'</span>\n                    <span class="item-quantity">').concat(m.quantity,' units</span>\n                    <span class="item-price">KES ').concat(m.price.toLocaleString(),"</span>\n                </div>\n            ")).join(""))},updateOrderSummary(){let e=0;window.CartComponent&&(e=window.CartComponent.getTotal());const t=500,o=e+t,n=document.getElementById("summarySubtotal"),a=document.getElementById("summaryDelivery"),s=document.getElementById("summaryTotal");n&&(n.textContent="KES ".concat(e.toLocaleString())),a&&(a.textContent="KES ".concat(t.toLocaleString())),s&&(s.textContent="KES ".concat(o.toLocaleString()))},sendOrder(){const e=document.getElementById("customerName")?document.getElementById("customerName").value:"",t=document.getElementById("customerPhone")?document.getElementById("customerPhone").value:"",o=document.getElementById("customerLocation")?document.getElementById("customerLocation").value:"";if(!e||!t||!o){this.showError("Please fill in all required fields in step 1"),this.showStep(1);return}const n=this.generateWhatsAppMessage(e,t,o),a="https://wa.me/254743375997?text=".concat(encodeURIComponent(n));window.open(a,"_blank"),this.showSuccess("Order sent to WhatsApp! Please complete your order there."),setTimeout(()=>{this.close()},3e3)},generateWhatsAppMessage(e,t,o){const n=window.CartComponent?window.CartComponent.getItems():[],a=window.CartComponent?window.CartComponent.getTotal():0;let s="ðŸ  *TURF GRASS ORDER*\n\n";return s+="*Customer Details:*\n",s+="Name: ".concat(e,"\n"),s+="Phone: +254".concat(t,"\n"),s+="Location: ".concat(o,"\n\n"),s+="*Order Items:*\n",n.forEach(c=>{s+="â€¢ ".concat(c.name," - ").concat(c.quantity," units - KES ").concat(c.price.toLocaleString(),"\n")}),s+="\n*Total: KES ".concat(a.toLocaleString(),"*\n\n"),s+="Please confirm this order and provide delivery details.",s},placeOrder(){if(!document.getElementById("checkoutForm"))return;const t={name:document.getElementById("checkoutName")?document.getElementById("checkoutName").value:"",email:document.getElementById("checkoutEmail")?document.getElementById("checkoutEmail").value:"",phone:document.getElementById("checkoutPhone")?document.getElementById("checkoutPhone").value:"",location:document.getElementById("checkoutLocation")?document.getElementById("checkoutLocation").value:"",address:document.getElementById("checkoutAddress")?document.getElementById("checkoutAddress").value:"",city:document.getElementById("checkoutCity")?document.getElementById("checkoutCity").value:"",saveDetails:document.getElementById("saveDetails")?document.getElementById("saveDetails").checked:!1,allowPhoneContact:document.getElementById("allowPhoneContact")?document.getElementById("allowPhoneContact").checked:!1,items:window.CartComponent?window.CartComponent.getItems():[],total:window.CartComponent?window.CartComponent.getTotal():0};if(!t.name||!t.email||!t.phone||!t.location||!t.address||!t.city){this.showError("Please fill in all required fields");return}t.saveDetails&&this.saveDetails();const o=t.allowPhoneContact?"phone call":"email";this.showSuccess("Order placed successfully! We will contact you via ".concat(o," soon.")),window.CartComponent&&window.CartComponent.clear(),setTimeout(()=>{this.close()},2e3)},showError(e){console.error("Checkout Error:",e),alert(e)},showSuccess(e){console.log("Checkout Success:",e),alert(e)},detectPhoneFromContacts(){return u(this,null,function*(){const e=document.getElementById("detectPhoneBtn"),t=document.getElementById("customerPhone");if(!(!e||!t)){e.classList.add("loading"),e.innerHTML='<i class="fas fa-spinner"></i><span>Detecting...</span>',e.disabled=!0;try{if("contacts"in navigator&&"select"in navigator.contacts){const o=yield navigator.contacts.select(["name","tel"],{multiple:!1});if(o&&o.length>0){const n=o[0],a=n.tel&&n.tel.length>0?n.tel[0]:null;if(a){let s=a.replace(/\D/g,"");s.startsWith("254")&&(s=s.substring(3)),t.value=s,e.classList.remove("loading"),e.classList.add("success"),e.innerHTML='<i class="fas fa-check"></i><span>Detected</span>',setTimeout(()=>{e.classList.remove("success"),e.innerHTML='<i class="fas fa-address-book"></i><span>Detect from Contacts</span>',e.disabled=!1},2e3),this.showSuccess("Phone number detected from contacts!")}else throw new Error("No phone number found in selected contact")}else throw new Error("No contact selected")}else{const o=prompt("Please enter your phone number or copy it from your contacts:");if(o)t.value=o.replace(/\D/g,""),e.classList.remove("loading"),e.classList.add("success"),e.innerHTML='<i class="fas fa-check"></i><span>Entered</span>',setTimeout(()=>{e.classList.remove("success"),e.innerHTML='<i class="fas fa-address-book"></i><span>Detect from Contacts</span>',e.disabled=!1},2e3);else throw new Error("No phone number entered")}}catch(o){console.error("Error detecting phone:",o),e.classList.remove("loading"),e.classList.add("error"),e.innerHTML='<i class="fas fa-exclamation-triangle"></i><span>Failed</span>',setTimeout(()=>{e.classList.remove("error"),e.innerHTML='<i class="fas fa-address-book"></i><span>Detect from Contacts</span>',e.disabled=!1},2e3),this.showError("Could not detect phone number. Please enter it manually.")}}})},detectLocationFromGPS(){return u(this,null,function*(){const e=document.getElementById("detectLocationBtn"),t=document.getElementById("customerLocation");if(!(!e||!t)){e.classList.add("loading"),e.innerHTML='<i class="fas fa-spinner"></i><span>Detecting...</span>',e.disabled=!0;try{if("geolocation"in navigator){const o=yield new Promise((s,c)=>{navigator.geolocation.getCurrentPosition(s,c,{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})}),{latitude:n,longitude:a}=o.coords;try{const c=yield(yield fetch("https://nominatim.openstreetmap.org/reverse?format=json&lat=".concat(n,"&lon=").concat(a,"&zoom=18&addressdetails=1"))).json();c.display_name?(t.value=c.display_name,e.classList.remove("loading"),e.classList.add("success"),e.innerHTML='<i class="fas fa-check"></i><span>Detected</span>',setTimeout(()=>{e.classList.remove("success"),e.innerHTML='<i class="fas fa-map-marker-alt"></i><span>Use GPS</span>',e.disabled=!1},2e3),this.showSuccess("Location detected from GPS!")):(t.value="".concat(n.toFixed(6),", ").concat(a.toFixed(6)),e.classList.remove("loading"),e.classList.add("success"),e.innerHTML='<i class="fas fa-check"></i><span>Detected</span>',setTimeout(()=>{e.classList.remove("success"),e.innerHTML='<i class="fas fa-map-marker-alt"></i><span>Use GPS</span>',e.disabled=!1},2e3))}catch(s){t.value="".concat(n.toFixed(6),", ").concat(a.toFixed(6)),e.classList.remove("loading"),e.classList.add("success"),e.innerHTML='<i class="fas fa-check"></i><span>Detected</span>',setTimeout(()=>{e.classList.remove("success"),e.innerHTML='<i class="fas fa-map-marker-alt"></i><span>Use GPS</span>',e.disabled=!1},2e3)}}else throw new Error("Geolocation not supported")}catch(o){console.error("Error detecting location:",o),e.classList.remove("loading"),e.classList.add("error"),e.innerHTML='<i class="fas fa-exclamation-triangle"></i><span>Failed</span>',setTimeout(()=>{e.classList.remove("error"),e.innerHTML='<i class="fas fa-map-marker-alt"></i><span>Use GPS</span>',e.disabled=!1},2e3),this.showError("Could not detect location. Please enter it manually.")}}})},loadSavedDetails(){try{const e=localStorage.getItem("checkoutDetails");if(e){const t=JSON.parse(e);if(t.name){const n=document.getElementById("customerName");n&&(n.value=t.name)}if(t.phone){const n=document.getElementById("customerPhone");n&&(n.value=t.phone)}if(t.email){const n=document.getElementById("customerEmail");n&&(n.value=t.email)}if(t.location){const n=document.getElementById("customerLocation");n&&(n.value=t.location)}const o=document.getElementById("rememberDetails");o&&(o.checked=!0),setTimeout(()=>{this.initFloatingLabels()},50)}}catch(e){console.error("Error loading saved details:",e)}},saveDetails(){const e=document.getElementById("rememberDetails");if(e&&e.checked)try{const t={name:document.getElementById("customerName")?document.getElementById("customerName").value:"",phone:document.getElementById("customerPhone")?document.getElementById("customerPhone").value:"",email:document.getElementById("customerEmail")?document.getElementById("customerEmail").value:"",location:document.getElementById("customerLocation")?document.getElementById("customerLocation").value:""};localStorage.setItem("checkoutDetails",JSON.stringify(t)),console.log("Details saved to localStorage")}catch(t){console.error("Error saving details:",t)}},showStep(e){console.log("showStep called with stepNumber:",e),document.querySelectorAll(".checkout-step").forEach(n=>n.classList.remove("active"));const o=document.getElementById("step".concat(e));o&&o.classList.add("active"),this.currentStep=e,console.log("Current step updated to:",this.currentStep),this.updateStepIndicator(),this.updateButtonStates(),e===2&&this.populateSummaryData(),e===3&&this.populateMessagePreview()},populateSummaryData(){const e=document.getElementById("customerName")?document.getElementById("customerName").value:"",t=document.getElementById("customerPhone")?document.getElementById("customerPhone").value:"",o=document.getElementById("customerLocation")?document.getElementById("customerLocation").value:"",n=document.getElementById("summaryName"),a=document.getElementById("summaryPhone"),s=document.getElementById("summaryLocation");n&&(n.textContent=e||"Not provided"),a&&(a.textContent=t?"+254".concat(t):"Not provided"),s&&(s.textContent=o||"Not provided")},populateMessagePreview(){const e=document.getElementById("customerName")?document.getElementById("customerName").value:"",t=document.getElementById("customerPhone")?document.getElementById("customerPhone").value:"",o=document.getElementById("customerLocation")?document.getElementById("customerLocation").value:"",n=this.generateWhatsAppMessage(e,t,o),a=document.getElementById("messagePreview");a&&(a.textContent=n)},nextStep(){this.currentStep<this.totalSteps&&this.showStep(this.currentStep+1)},previousStep(){this.currentStep>1&&this.showStep(this.currentStep-1)},updateStepIndicator(){const e=document.querySelectorAll(".md3-stepper .step"),t=document.querySelectorAll(".md3-stepper .rail");console.log("Updating step indicator. Current step:",this.currentStep),console.log("Found steps:",e.length,"Found rails:",t.length),e.forEach((o,n)=>{const a=n+1;o.classList.remove("is-active","completed"),a===this.currentStep?(o.classList.add("is-active"),console.log("Step ".concat(a," is now active"))):a<this.currentStep&&(o.classList.add("completed"),console.log("Step ".concat(a," is now completed")))}),t.forEach((o,n)=>{o.classList.remove("completed","active"),console.log("Rail ".concat(n+1," classes removed")),n<this.currentStep-1?(o.classList.add("completed"),console.log("Rail ".concat(n+1," is now completed"))):n===this.currentStep-1&&(o.classList.add("active"),console.log("Rail ".concat(n+1," is now active (50% filled)")))})},updateButtonStates(){const e=document.getElementById("backBtn"),t=document.getElementById("nextBtn"),o=document.getElementById("sendBtn");console.log("updateButtonStates called, currentStep:",this.currentStep),console.log("backBtn found:",!!e),e?(e.style.display="grid",console.log("Back button should be visible")):console.log("Back button not found in DOM"),t&&(this.currentStep===1?t.innerHTML='Review Order <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M13 5l7 7-7 7" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>':this.currentStep===2&&(t.innerHTML='Send Order <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M13 5l7 7-7 7" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>')),o&&(this.currentStep===3?(o.style.display="inline-flex",t&&(t.style.display="none")):(o.style.display="none",t&&(t.style.display="inline-flex")))},initFloatingLabels(){const e=document.querySelectorAll(".md3-field input");console.log("Initializing floating labels for",e.length,"inputs"),e.forEach((t,o)=>{(!t.placeholder||t.placeholder==="")&&(t.placeholder=" "),t.removeEventListener("input",this.updateFloatingLabel.bind(this,t)),t.removeEventListener("focus",this.updateFloatingLabel.bind(this,t)),t.removeEventListener("blur",this.updateFloatingLabel.bind(this,t)),t.addEventListener("input",()=>{this.updateFloatingLabel(t)}),t.addEventListener("focus",()=>{this.updateFloatingLabel(t)}),t.addEventListener("blur",()=>{this.updateFloatingLabel(t)}),this.updateFloatingLabel(t),console.log("Input ".concat(o+1,":"),t.id||t.name,"initialized")})},updateFloatingLabel(e){const t=e.parentElement.querySelector(".md3-label");if(!t){console.warn("No label found for input:",e.id||e.name);return}const o=e.value.trim().length>0,n=document.activeElement===e;o?e.classList.add("has-value"):e.classList.remove("has-value"),o||n?t.classList.add("floating"):t.classList.remove("floating"),o||n?e.style.setProperty("--placeholder-opacity","0"):e.style.removeProperty("--placeholder-opacity"),console.log("Updated floating label for ".concat(e.id||e.name,":"),{hasValue:o,isFocused:n,hasValueClass:e.classList.contains("has-value"),hasFloatingClass:t.classList.contains("floating")})}};export{g as checkoutModal};
